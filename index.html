<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pumpkin Carving Contest 🎃</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/counterapi/dist/counter.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body>
    <h1>🎃 2025 City of Savage Pumpkin Carving Contest 🎃</h1>
    <div class="page-views">
        <span class="label">Page Views:</span>
        <span id="view-count">Loading...</span>
    </div>
    <div class="image-container">
        <img src="images/trick-or-treat-halloween.gif" alt="Dog dressed as a ghost for Halloween holding a pumpkin-shaped bucket in its mouth, standing in a brightly lit hallway with tiled floor. Text at the bottom reads THIS WILL BE ROCKOS COSTUME. The scene is playful and festive." />
    </div>
    <div class="would-you-rather">
      <span class="label">Would you rather be trapped with spiders... or snakes?</span>
    </div>
    <div class="this-or-that">
      <button id="spiderBtn" class="vote-btn">🕷️ Spiders</button>
      <button id="snakeBtn" class="vote-btn">🐍 Snakes</button>
    </div>
    <div class="vote-results" id="vote-results">Loading votes...</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const counter = new Counter({ workspace: 'cos' });

    // Button variables
    const spiderBtn = document.getElementById('spiderBtn');
    const snakeBtn = document.getElementById('snakeBtn');
    const voteResultsEl = document.getElementById('vote-results');
    const viewCountEl = document.getElementById('view-count');

    // Confetti variables
    var scalar = 2; // Adjust size of emoji
    var spiderIco = confetti.shapeFromText({ text: '🕷️', scalar })
    var snakeIco = confetti.shapeFromText({ text: '🐍', scalar })
    var defaults = {
        spread: 160,
        ticks: 60,
        gravity: 0.5,
        decay: 0.9,
        startVelocity: 20,
        scalar
    };
    const spiderBox = document.getElementById('spiderBtn');
    const snakeBox = document.getElementById('snakeBtn');
    const snakeRect = snakeBtn.getBoundingClientRect();
    const spiderRect = spiderBtn.getBoundingClientRect();    
    const spiderX = (spiderRect.left + spiderRect.right) / 2;
    const spiderY = (spiderRect.top + spiderRect.bottom) / 2;
    const snakeX = (snakeRect.left + snakeRect.right) / 2;
    const snakeY = (snakeRect.top + snakeRect.bottom) / 2;
 
    let upCount = 0;
    let downCount = 0;

    // Track page view count
    counter.up('2025-cos-pumpkin-carving-contest')
      .then(result => {
        viewCountEl.textContent = result.data.up_count;
      })
      .catch(error => {
        console.error('[View Counter] Error incrementing page view:', error);
        viewCountEl.textContent = 'Error loading count';
      });

    // Helper function to render vote text
    function renderVotes() {
      voteResultsEl.textContent = `🕷️ Spiders: ${upCount} | 🐍 Snakes: ${downCount}`;
    }

    // Get initial votes from API
    async function updateVotes() {
      try {
        const res = await counter.get('this-or-that');
        upCount = res.data?.up_count ?? 0;
        downCount = res.data?.down_count ?? 0;
        renderVotes();
      } catch (error) {
        console.error('[Vote Fetch] Error fetching vote data:', error);
        voteResultsEl.textContent = 'Error loading votes';
      }
    }

    updateVotes();

    // Handle "Spiders" button click
    spiderBtn.addEventListener('click', async () => {
      upCount++;
      renderVotes(); // immediate feedback
      confetti({
        ...defaults,
        shapes: [spiderIco],
        origin: {x: spiderX / window.innerWidth, y: spiderY / window.innerHeight}
      })

      try {
        await counter.up('this-or-that');
        setTimeout(updateVotes, 1500); // sync after API updates
      } catch (error) {
        console.error('[Spiders Button] Error sending UP vote to CounterAPI:', error);
        upCount--; // revert local change
        renderVotes();
      }
    });

    // Handle "Snakes" button click
    snakeBtn.addEventListener('click', async () => {
      downCount++;
      renderVotes(); // immediate feedback
      confetti({
        ...defaults,
        shapes: [snakeIco],
        origin: {x: snakeX / window.innerWidth, y: snakeY / window.innerHeight}
      })

      try {
        await counter.down('this-or-that');
        setTimeout(updateVotes, 1500);
      } catch (error) {
        console.error('[Snakes Button] Error sending DOWN vote to CounterAPI:', error);
        downCount--; // revert local change
        renderVotes();
      }
    });
  });
</script>

</body>
</html>
